name: Jar File Build

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write  # 'write' 권한 추가

jobs:    
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.generate_tag.outputs.tag_name }}  # output으로 tag_name 설정
    steps:
    - name: Checkout repository For Create Tag
      uses: actions/checkout@v4

    - name: Set up Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Generate Tag
      id: generate_tag
      run: |
        REPO_NAME=$(basename $(pwd))
        USER_NAME="${{ github.actor }}"     # GitHub 액션을 트리거한 사용자
        DATE=$(date +'%Y%m%d_%H%M')
        TAG_NAME="${REPO_NAME}-${USER_NAME}-${DATE}"
        echo "Generated Tag: $TAG_NAME"
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV  # 환경 변수로 설정
        echo "::set-output name=tag_name::$TAG_NAME"  # output으로 설정

    - name: Authenticate with GIT_TOKEN
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.GIT_TOKEN }}@github.com/${{ github.repository }}
        
    - name: Create and push tag
      run: |
        git tag ${{ env.TAG_NAME }}          # 환경 변수로 생성한 태그 사용
        git push origin ${{ env.TAG_NAME }}  # 푸시

  jar-build:
    runs-on: ubuntu-latest
    needs: create-tag
    steps:    
    - name: Checkout repository For Jar Build
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'corretto'
        cache: maven
        java-package: jdk
        check-latest: false
        overwrite-settings: true
        job-status: success

    - name: Jar Build with Maven
      run: mvn clean package

  docker-image-build:
    runs-on: ubuntu-latest
    needs: jar-build
    steps:
    - name: Checkout repository For Docker Image Build
      uses: actions/checkout@v4    

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Set up AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
        aws-region: ap-northeast-2

    - name: Set Environment Variables
      run: |
        echo "ECR_REPO=sun-test" >> $GITHUB_ENV
        echo "AWS_ACCOUNT_ID=890742611047" >> $GITHUB_ENV
        echo "ECR_URL=dkr.ecr.ap-northeast-2.amazonaws.com" >> $GITHUB_ENV
        echo "TAG_NAME=${{ needs.create-tag.outputs.tag_name }}" >> $GITHUB_ENV  # needs로 tag_name을 가져옴

    - name: ECR Login
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Docker Image Build and Push to ECR
      run: |
        docker build -t ${{ env.AWS_ACCOUNT_ID }}.${{ env.ECR_URL }}/${{ env.ECR_REPO }}:${{ env.TAG_NAME }} -f $GITHUB_WORKSPACE/Dockerfile $GITHUB_WORKSPACE/
        docker push ${{ env.AWS_ACCOUNT_ID }}.${{ env.ECR_URL }}/${{ env.ECR_REPO }}:${{ env.TAG_NAME }}
  

